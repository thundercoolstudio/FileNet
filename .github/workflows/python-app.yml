       
name: Flask with cpolar (Guaranteed Startup)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'  # æ¯4å°æ—¶é‡å¯ï¼ˆé¿å…6å°æ—¶é™åˆ¶ï¼‰

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip jq
        
        # å®‰è£…cpolarï¼ˆä½¿ç”¨å®˜æ–¹æ¨èçš„é™é»˜å®‰è£…æ–¹å¼ï¼‰
        curl -sL https://www.cpolar.com/static/downloads/install-release-cpolar.sh | sudo bash
        sudo cpolar service install --accept-tcp-term
        echo "NWQwYWM4NDMtOTE2Ni00NTA2LThlNjctMzdhZDlkNjhlMjQ0" | sudo cpolar authtoken -
        
        pip install -r requirements.txt

    - name: Start services and get URL
      id: run-app
      run: |
        # 1. å¯åŠ¨Flaskåº”ç”¨ï¼ˆåå°ï¼‰
        nohup python main.py > app.log 2>&1 &
        echo "Flask PID: $!"
        
        # 2. å¯åŠ¨cpolaréš§é“ï¼ˆä½¿ç”¨systemdæœåŠ¡ï¼‰
        sudo cpolar service start http --port 5000 --hostname flask-app --region hk
        
        # 3. ç­‰å¾…å¹¶è·å–å…¬ç½‘URLï¼ˆé‡è¯•æœºåˆ¶ï¼‰
        sleep 30
        for i in {1..10}; do
          PUBLIC_URL=$(sudo cpolar service status http --format json | jq -r '.public_url')
          if [ -n "$PUBLIC_URL" ]; then
            echo "::set-output name=public_url::$PUBLIC_URL"
            break
          fi
          echo "Attempt $i: Waiting for cpolar to start..."
          sleep 15
        done
        
        # 4. æŒç»­æ—¥å¿—è¾“å‡º
        tail -f app.log /var/log/cpolar/*.log
      timeout-minutes: 30

    - name: Show public URL
      run: |
        if [ -n "${{ steps.run-app.outputs.public_url }}" ]; then
          echo "ğŸŒ å…¬ç½‘è®¿é—®åœ°å€: ${{ steps.run-app.outputs.public_url }}"
        else
          echo "âŒ æœªèƒ½è·å–å…¬ç½‘URLï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        fi

